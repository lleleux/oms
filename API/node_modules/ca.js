/**
 * =============================
 *
 * Certification authority manager
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods : /
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var fs = require('fs');
// Global
var logger = require('logger');
var utils = require('utils');
var Dao = require('db').Dao;
// Custom
var dbCommander = require('dbCommander');



/**
 * Variables
 */

// DAO
var config = new Dao('config');
var devices = new Dao('devices');
var installs = new Dao('installs');



/**
 * Initialize a new CA. Create the directory, a key, a certificate...
 */

var initialize = function (callback) {
	config.findOne({name: 'certificationAuthority'}, function (ca) {
		var parameters = {
			ca_directory:	ca.directory,
			password:		ca.private_key.passphrase
		};
		dbCommander.command('init_ca', parameters, function() {
			if (callback) callback();
		});
	});
};



/**
 * Create Agent private key and certificate
 */

var initializeAgent = function (agentId, callback) {
	config.findOne({name: 'certificationAuthority'}, function (ca) {
		var parameters = {
			ca_directory:	ca.directory,
			password:		ca.private_key.passphrase,
			agent_id:		agentId
		};
		dbCommander.command('init_agent', parameters, function(result) {
			if (result.code == 0) {
				var split = result.data.split('-----END RSA PRIVATE KEY-----');
				var key = split[0] + '-----END RSA PRIVATE KEY-----';
				var cert = split[1];
				installs.update(installId, {private_key: key, certificate: cert}, callback);
			} else {
				logger.warn('[CA] Unable to create agent credentials: code = ' + result.code + ', output = ' + result.data)
			}
		});
	});
};



/**
 * Ban agent by setting his certificate in the CRL
 * Generate the new crl.
 *
 * Only works with "installed" and "created" agents.
 */

var banAgent = function (agentId, callback) {
	logger.info('[CA] Ban the agent: ' + agentId);
	// Get the CA infos
	config.findOne({name: 'certificationAuthority'}, function (ca) {
		var parameters = {
			ca_directory:	ca.directory,
			password:		ca.private_key.passphrase,
			agent_id:		agentId
		};
		dbCommander.command('revoke', parameters, function (result) {
			if (result.code === 0) {
				config.update(ca.id, {crl: {last_generation: new Date().getTime()}}, callback);
			}
		});
	});
};



/**
 * Exports
 */

// Methods
exports.initialize = initialize;
exports.initializeAgent = initializeAgent;
exports.banAgent = banAgent;