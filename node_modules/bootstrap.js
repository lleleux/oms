/**
 * Load modules
 */

// Built-in
var fs  = require('fs');
var os = require('os');
var async = require('async');
// Global
var logger = require('logger');
var config = require('config');
var db = require('db');
// Custom
var registration = require('./bootstrap/registration');



/**
 * Variables
 */

// Config
var bootstrapConfig;
var files = ['/etc/oms/bootstrap.properties'];

// Application gracefull exit method
var appGracefulExit;



/**
 * Bootstrap the Server. Opens database connections, set exit handlers...
 *
 * Takes the 3 arguments
 *		- The oms application identifier (api/dev-helper/agent-manager/admin-panel)
 *		- The application gracefull exit callback, a function called before exiting
 *		  the server, he must close all the ressources an call a callback !
 *		  the execution time may not exceed 5 seconds...
 *		- a callback executed after the bootstrap is ended.
 */

var bootstrap = function (omsService, appGracefulExitCallback, callback) {
	appGracefulExit = appGracefulExitCallback;
	_loadConfig();
	db.open(bootstrapConfig.dbHost, bootstrapConfig.dbPort, ['oms', 'doc'], function () {
		config.serviceTmpDir = os.tmpdir() + '/' + omsService + '/';
		config.serverTmpDir = os.tmpdir() + '/oms/';
		config.load(omsService, function () {
			registration.register(function () {
				_bootstrapService(omsService, callback);
			});
		});
	});
	process.on('SIGTERM', _gracefulExit);
	process.on('SIGINT', _gracefulExit);
	process.on('uncaughtException', _gracefulExit);
};



/**
 * Load bootstrap configuration (DB connection info)
 */

var _loadConfig = function () {
	// Search config file
	var file;
	for (key in files) {
		if (fs.existsSync(files[key])) {
			file = files[key];
			break;
		}
	}
	// If no config file found
	if (file === undefined) {
		throw new Error('[Bootstrap] No config file found in the following places: ' + files);
	}

	// Start loading config
	logger.info('[Bootstrap] Start loading config file: ' + file);
	// Read file content
	var fileContents = fs.readFileSync(file, 'UTF-8');
	// Populate config
	bootstrapConfig = {};
	fileContents.split('\n').forEach(function (line) {
		var split = line.split('=');
		// If the line is of type 'key=value' and starts not with a '#'
		if (split.length == 2 && split[0].charAt(0) != '#' && split[0].length > 0 && split[1].length > 0) {
			bootstrapConfig[split[0].trim()] = split[1].trim();
		}
	});
	logger.info('[Bootstrap] Config file ' + file + ' loaded');
};



/**
 * Bootstrap a specific service
 *
 * First, the "oms-all" file is opened and every method
 * in it is executed in a defined order :
 *		- "before" tasks in parallel
 *		- "tasks" tasks in parallel
 *		- "after" tasks in parallel
 * The before/tasks/after are executed in serie.
 *
 * After these tasks, the service specific file is opened and
 * executed in the same way as the "oms-all" file.
 */

var _bootstrapService = function (omsService, callback) {
	var omsService = config.get('omsService')
	var all = require('./bootstrap/oms-all.js');
	var service = require('./bootstrap/' + omsService + '.js');
	// Prepare execution of "oms-all" and "oms-service" functions in serie :
	// before -> tasks -> after -> before -> tasks -> after
	// All the functions in each part are executed in parallel
	var serie = [
		function (callback) { async.parallel(all.before, callback); },
		function (callback) { async.parallel(all.tasks, callback); },
		function (callback) { async.parallel(all.after, callback); },
		function (callback) { async.parallel(service.before, callback); },
		function (callback) { async.parallel(service.tasks, callback); },
		function (callback) { async.parallel(service.after, callback); }
	];
	// Execute the serie of bootstraps
	async.series(serie, function (err) {
		if (err) {
			throw err;
		} else {
			if (callback) callback();
		}
	});
};



/**
 * Graceful Exit
 */

var _gracefulExit = function () {
	logger.warn('[Bootstrap] Gracefull exit started')

	// Unregister server in DB and close the database, after, exit gracefully
	var unregisterAndClose = function () {
		registration.unregister(function () {
			db.close(function () {
				logger.info('[Bootstrap] Server gracefully closed');
				process.exit();
			});
		});
	};

	// Set timer to force unregister and close DB in 5 seconds, if the appGracefulExit does not work.
	setTimeout(function() {
		unregisterAndClose();
	}, 5000);

	// Set timer to force exit in 10 seconds
	setTimeout(function() {
		logger.info('[Bootstrap] Server forced closed');
		process.exit();
	}, 10000);

	// Call the Application gracefull exit method
	appGracefulExit(function () {
		unregisterAndClose();
	});
};



/**
 * Exports
 */

// Methods
exports.bootstrap = bootstrap;