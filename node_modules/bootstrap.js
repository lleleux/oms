/**
 * Load modules
 */

// Built-in
var fs  = require('fs');
var os = require('os');
// Global
var logger = require('logger');
var config = require('config');
var db = require('db');
var utils = require('utils');



/**
 * Variables
 */

// Config
var configuration;
var files = ['/etc/oms/bootstrap.properties'];

// Dao
var servers = new db.Dao('servers');
var configDao = new db.Dao('config');

// Server ID 		TODO persist on server
var serverId;
// Application gracefull exit method
var appGracefulExit;



/**
 * Bootstrap the Server. Opens database connections, set exit handlers...
 *
 * Takes the 3 arguments
 *		- The oms application identifier (api/dev-helper/agent-manager/admin-panel)
 *		- The application gracefull exit callback, a function called before exiting
 *		  the server, he must close all the ressources an call a callback !
 *		  the execution time may not exceed 5 seconds...
 *		- a callback executed after the bootstrap is ended.
 */

var bootstrap = function (omsApplication, appGracefulExitCallback, callback) {
	appGracefulExit = appGracefulExitCallback;
	_loadConfig();
	db.open(configuration.dbHost, configuration.dbPort, 'oms', function () {
		db.open(configuration.dbHost, configuration.dbPort, 'doc', function () {
			config.set('omsApplication', omsApplication);
			config.set('tmpDir', os.tmpdir() + '/' + omsApplication + '/');
			config.loadFromDB(omsApplication, function () {
				_register(omsApplication, callback);
				_bootstrapApplication(omsApplication);	// TODO sync
			});
		});
	});
	process.on('SIGTERM', _gracefulExit);
	process.on('SIGINT', _gracefulExit);
	process.on('uncaughtException', _gracefulExit);
};



/**
 * Load bootstrap configuration (DB connection info)
 */

var _loadConfig = function () {
	// Search config file
	var file;
	for (key in files) {
		if (fs.existsSync(files[key])) {
			file = files[key];
			break;
		}
	}
	// If no config file found
	if (file === undefined) {
		logger.error('[Bootstrap] No config file found in the following places: ' + files);
		throw new Error('[Bootstrap] No config file found in the following places: ' + files);
	}

	// Start loading config
	logger.info('[Bootstrap] Start loading config file: ' + file);
	// Read file content
	var fileContents = fs.readFileSync(file, 'UTF-8');
	// Populate config
	configuration = {};
	fileContents.split('\n').forEach(function (line) {
		var split = line.split('=');
		// If the line is of type 'key=value' and starts not with a '#'
		if (split.length == 2 && split[0].charAt(0) != '#' && split[0].length > 0 && split[1].length > 0) {
			configuration[split[0].trim()] = split[1].trim();
		}
	});
	logger.info('[Bootstrap] Config file ' + file + ' loaded');
};



/**
 * Register the server in the DataBase.
 * If an error occurs, an error is thrown.
 */

var _register = function (omsApplication, callback) {
	var serverInfos = {
		hostname:			os.hostname(),
		totalMemory:		os.totalmem(),
		cpus:				os.cpus(),
		networkInterfaces:	os.networkInterfaces(),
		architecture:		os.arch(),
		platform:			os.platform(),
		type:				os.type(),
		tmpDir:				os.tmpdir(),
		omsApplication: 	omsApplication
	};
	servers.insert(serverInfos, function (result) {
		serverId = result[0]._id;
		// If server correctly registered
		if (serverId !== undefined) {
			logger.info('[Bootstrap] Server registered with the id: ' + serverId);
			if (callback) callback();
		}
		// If error during registration
		else {
			logger.error('[Bootstrap] Unable to register the server');
			throw new Error('[Bootstrap] Unable to register the server');
		}
	});
};



/**
 * Unregister the server of the database
 * If the serverId is undefined, only calls the callback.
 */

var _unregister = function (callback) {
	if (serverId) {
		servers.remove(serverId, function () {
			// Set serverId to undefined to not try to remove it several times
			serverId = undefined;
			logger.info('[Bootstrap] Server unregistered');
			if (callback) callback();
		});
	} else {
		logger.warn('[Bootstrap] Server not registered');
		if (callback) callback();
	}
};



/**
 * Bootstrap specific application
 */

var _bootstrapApplication = function (omsApplication) {
	// Initialize TMP directory for the application
	var tmpDir = config.get('tmpDir');
	if (fs.existsSync(tmpDir)) {
		logger.warn('[Bootstrap] Temporary directory ' + tmpDir + ' not deleted during the past application run');
		utils.rmdirrfSync(tmpDir);
	}
	fs.mkdirSync(tmpDir);
	// Specific bootstrap per application
	switch (omsApplication) {
		case 'oms-api':
			// Get CA files
			configDao.findOne({name: 'certificationAuthority'}, function (ca) {
				fs.writeFileSync(tmpDir + ca.certificate.filename, ca.certificate.contents);
				fs.writeFileSync(tmpDir + ca.private_key.filename, ca.private_key.contents);
			});
			break;
		case 'oms-agent-manager':
			break;
		case 'oms-admin-panel':
			break;
		case 'oms-dev-helper':
			break;
		default:
			logger.error('[Bootstrap] Unknown omsApplication for the application bootstrap: ' + omsApplication);
			break;
	}
}



/**
 * Graceful Exit
 */

var _gracefulExit = function () {
	logger.warn('[Bootstrap] Gracefull exit started')

	// Unregister server in DB and close the database, after, exit gracefully
	var unregisterAndClose = function () {
		_unregister(function () {
			db.close('doc', function () {
				db.close('oms', function () {
					logger.info('[Bootstrap] Server gracefully closed');
					process.exit();
				});
			});
		});
	}

	// Set timer to force unregister and close DB in 5 seconds, if the appGracefulExit does not work.
	setTimeout(function() {
		unregisterAndClose();
	}, 5000);

	// Set timer to force exit in 10 seconds
	setTimeout(function() {
		logger.info('[Bootstrap] Server forced closed');
		process.exit();
	}, 10000);

	// Call the Application gracefull exit method
	appGracefulExit(function () {
		unregisterAndClose();
	});
}



/**
 * Exports
 */

// Methods
exports.bootstrap = bootstrap;