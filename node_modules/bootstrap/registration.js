/**
 * =============================
 *
 * Registration module for server and service registration
 * on bootstrap.
 *
 * Register the server and the service in the Database. Set
 * and update information about the server/service on boot
 * and exit time.
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods :
 *		- register(callback)
 *		- unregister(callback)
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var os = require('os');
// Global
var logger = require('logger');
var config = require('config');
var db = require('db');



/**
 * Variables
 */

// Dao
var serversDao = new db.Dao('servers');



/**
 * Register the server in the DataBase.
 * If an error occurs, an error is thrown.
 */

var register = function (callback) {
	serversDao.findOne({hostname: os.hostname()}, function (server) {
		// If no server, insert it, then register service
		if (server === undefined || server === null) {
			_registerServer(function (server) {
				_registerService(server, callback);
			});
		}
		// If a server, only register the service
		else {
			_registerService(server, callback);
		}
	});
};

// Register the server by inserting in DB
var _registerServer = function (callback) {
	var serverInfos = {
		hostname:			os.hostname(),
		totalMemory:		os.totalmem(),
		cpus:				os.cpus(),
		networkInterfaces:	os.networkInterfaces(),
		architecture:		os.arch(),
		platform:			os.platform(),
		release:			os.release(),
		type:				os.type(),
		tmpDir:				os.tmpdir(),
		maintenanceUser:	{
								username:	'oms'	// TODO
							},
		services:	 		{}
	};
	serversDao.insert(serverInfos, function (result) {
		// If server correctly registered
		if (result !== undefined && result !== null) {
			logger.info('[Bootstrap] Server registered');
			if (callback) callback(result[0]);
		}
		// If error during registration
		else {
			throw new Error('[Bootstrap] Unable to register the server');
		}
	});
};

// Register the service by updating the existing server
var _registerService = function (server, callback) {
	var omsService = config.omsService;
	// Add service
	if (server.services[omsService] === undefined) {
		var service = {
			name:		omsService,
			status:		'running',
			start:		new Date().getTime(),
			pid:		process.pid
		};
		var data = {};
		data['services.' + omsService] = service;
		serversDao.update(server._id, data, function () {
			logger.info('[Bootstrap] Service registered');
			if (callback) callback();
		});
	}
	// Update service
	else {
		var params = {};
		params['services.' + omsService + '.status'] = 'running';
		params['services.' + omsService + '.start'] = new Date().getTime();
		params['services.' + omsService + '.pid'] = process.pid;
		serversDao.update(server._id, params, function () {
			logger.info('[Bootstrap] Service registered');
			if (callback) callback();
		});
	}
};



/**
 * Unregister the server of the database
 * If the serverId is undefined, only calls the callback.
 */

var unregister = function (callback) {
	var omsService = config.omsService;
	var query = {};
	query.hostname = os.hostname();
	query['services.' + omsService] = {$exists: true};
	serversDao.findOne(query, function (server) {
		// Unregister the server
		if (server !== undefined && server !== null) {
			if (server.services[omsService]) {
				var params = {};
				params['services.' + omsService + '.status'] = 'stopped';
				params['services.' + omsService + '.stop'] = new Date().getTime();
				params['services.' + omsService + '.pid'] = '';
				serversDao.update(server._id, params, function () {
					logger.info('[Bootstrap] Service unregistered');
					if (callback) callback();
				});
			} else {
				logger.warn('[Bootstrap] Service is not registered');
				if (callback) callback();
			}

		}
		// If no server, problem...
		else {
			logger.warn('[Bootstrap] Server is not registered');
			if (callback) callback();
		}
	});
};



/**
 * Exports
 */
exports.register = register;
exports.unregister = unregister;