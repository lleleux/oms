/**
 * Load modules
 */

// Built-in
var fs = require('fs');
// Global
var config = require('config');
var db = require('db');
var logger = require('logger');



/**
 * Variables
 */

var serversDao = new db.Dao('servers');



/**
 * Add the maintenance user's private key to login with SSH
 * on other servers
 */
var addMaintenanceUserPrivateKey = function (callback) {
	// Search for servers
	serversDao.findAll(function (err, servers) {
		// For each server, set the ssh private key file in the maintenance user home to connect to the servers
		for (var server in servers) {
			var key = config.serverTmpDir + servers[server].hostname + '.key';
			fs.writeFileSync(key, servers[server].config.maintenancePrivateKey);
			fs.chmodSync(key, '600');
			logger.info('[Bootstrap] Maintenance user ready to connect : key got from DB');
		}
		if (callback) callback(null);
	});
};



/**
 * Exports
 */

// Variables
exports.before = 	[
					];
exports.tasks = 	[
						addMaintenanceUserPrivateKey
					];
exports.after = 	[
					];