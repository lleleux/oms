/**
 * Load modules
 */

var mongo = require('mongodb');
var config = require('config');
var logger = require('logger');



/**
 * Variables
 */

// Config
var dbHost = config.get('dbHost');
var dbPort = config.get('dbPort');
var omsDB = config.get('omsDB');
// DB Server
var db = [];
// BSON
var BSON = mongo.BSONPure;



/**
 * Open a database
 * By default, if no database is given, opens the OMS Database
 */

var connect = function (database, callback) {
	// Check the arguments, set the OMS DB by default
	if (typeof(database) === 'function') {
		callback = database;
		database = omsDB;
	} else if (database === undefined) {
		database = omsDB;
	}
	// Create the database connection
	var omsServer = new mongo.Server(dbHost, dbPort, {auto_reconnect: true});
	db[database] = new mongo.Db(database, omsServer, {safe: true});
	// Connect to the DB
	db[database].open(function (error, newDb) {
		if (!error) {
			logger.info('[DB] Connected to ' + database + ' database');
			if (callback) callback();
		} else {
			logger.warn('[DB] Unable to Connect to ' + database + ' database');
		}
	});
};



/**
 * DAO class definition
 */

function Dao(collectionName, database) {
	this.database = typeof database !== 'undefined' ? database : omsDB;;
	this.collectionName = collectionName;
};



/**
 * DAO generic methods
 */

Dao.prototype._update = function (selector, item, options, callback) {
	var collectionName = this.collectionName;
	logger.info('[DB] Update/Replace item from ' + collectionName);
	db[this.database].collection(collectionName, function (error, collection) {
		collection.update(selector, item, options, function (error, result) {
			if (error) {
				logger.warn('[DB] Error while updating items in ' + collectionName + ': ' + error);
			}
			logger.info('[DB] ' + result + ' items updated from ' + collectionName);
			// Result is the number of updated records
			if (callback) callback(result);
		});
	});
};

Dao.prototype._insert = function (item, options, callback) {
	var collectionName = this.collectionName;
	logger.info('[DB] Insert item(s) in ' + collectionName + ': ' + JSON.stringify(item));
	db[this.database].collection(collectionName, function (error, collection) {
		collection.insert(item, options, function (error, result) {
			if (result === undefined) {
				result = [];
			}
			logger.info('[DB] ' + result.length + ' items inserted in ' + collectionName);
			// Result is an array of inserted records
			if (callback) callback(result);
		});
	});
};

Dao.prototype._remove = function (selector, options, callback) {
	var collectionName = this.collectionName;
	logger.info('[DB] Delete item(s) from ' + collectionName + ' matching ' + JSON.stringify(selector));
	db[this.database].collection(collectionName, function (error, collection) {
		collection.remove(selector, options, function (error, result) {
			if (error) {
				logger.warn('[DB] Error while deleting items in ' + collectionName + ': ' + error);
			}
			logger.info('[DB] ' + result + ' items deleted from ' + collectionName);
			// Result is the number of deleted records
			if (callback) callback(result);
		});
	});
};



/**
 * Dao commonly used methods
 */

Dao.prototype.findOne = function (query, callback) {
	logger.info('[DB] Find one item from ' + this.collectionName + ' matching ' + query);
	db[this.database].collection(this.collectionName, function (error, collection) {
		collection.findOne(query, function (error, item) {
			logger.info('[DB] Item found : ' + item);
			if (callback) callback(item);
		});
	});
};

Dao.prototype.findById = function (id, callback) {
	id = new BSON.ObjectID(new String(id));
	this.findOne({_id: id}, callback);
};

Dao.prototype.find = function (query, callback) {
	logger.info('[DB] Find all items from ' + this.collectionName + ' matching ' + query);
	db[this.database].collection(this.collectionName, function (error, collection) {
		collection.find(query).toArray(function (error, items) {
			logger.info('[DB] ' + items.length + ' items found');
			if (callback) callback(items);
		});
	});
};

Dao.prototype.findAll = function (callback) {
	this.find({}, callback);
};

Dao.prototype.insert = function (item, callback) {
	this._insert(item, {continueOnError: true, w: 1}, callback);
};

Dao.prototype.update = function (id, item, callback) {
	id = new BSON.ObjectID(new String(id));
	item = {$set: item}
	this._update({'_id': id}, item, {}, callback);
};

Dao.prototype.replace = function (id, item, callback) {
	id = new BSON.ObjectID(new String(id));
	this._update({'_id': id}, item, {}, callback);
};

Dao.prototype.remove = function (id, callback) {
	id = new BSON.ObjectID(new String(id));
	this._remove({'_id': id}, {}, callback);
};

Dao.prototype.listen = function (callback) {
	logger.info('[DB] Listen for new documents from ' + this.collectionName);
	db[this.database].collection(this.collectionName, function (error, collection) {
		var latest = collection.find({}).sort({ $natural: -1 }).limit(1);
		latest.nextObject(function (error, doc) {
			var query = { _id: { $gt: doc._id }};
			var options = { tailable: true, awaitdata: true, numberOfRetries: -1 };
			var cursor = collection.find(query, options).sort({ $natural: 1 });
			var next = function () {
				cursor.nextObject(function (error, message) {
				callback(message);
				next();
				});
			};
			next();
		});
	});

}



/**
 * Exports
 */

// variables
exports = module.exports = db;
exports.BSON = BSON;
// methods
exports.connect = connect;
exports.Dao = Dao;