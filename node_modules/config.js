/**
 * Load modules
 */

// Built-in
var os = require('os');
// Global
var logger = require('logger');



/**
 * Variables
 */

var config = {};



/**
 * Load the config from the database
 */

var loadFromDB = function (omsApplication, callback) {
	logger.info('[Config] Start loading config from database for application ' + omsApplication);
	var Dao = require('db').Dao;
	var dao = new Dao('config');
	dao.findOne({name: omsApplication}, function (result) {
		// If no config found
		if (result === undefined || result === null) {
			logger.error('[Config] Unable to load config from database for application ' + omsApplication)
			throw 'Unable to load config from database for application ' + omsApplication;
		}
		// Delete unnecessary properties
		delete result._id;
		delete result.name;
		// Copy properties
		for (key in result) {
			if (result.hasOwnProperty(key)) {
				if (config[key] !== undefined) {
					logger.warn('[Config] Overriding configuration: config[' + key + ']=' + config[key] + ' by ' + result[key]);
					throw 'Overriding configuration: config[' + key + ']=' + config[key] + ' by ' + result[key];
				}
				config[key] = result[key];
			}
		}
		// Done
		logger.info('[Config] Config loaded from database');
		if (callback) callback();
	});
}



/**
 * Get a config value, undefined else.
 */

var get = function (key) {
	return config[key];
};



/**
 * Set a config value that will be available only on the
 * current application run. After reboot, it will be loosed.
 */

var set = function (key, value) {
	config[key] = value;
};



/**
 * Exports
 */

exports.get = get;
exports.set = set;
exports.loadFromDB = loadFromDB;