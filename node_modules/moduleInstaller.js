/**
 * =============================
 *
 * Description
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods : /
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var fs = require('fs');
// Global
var logger = require('logger');
var db = require('db');
var utils = require('utils');



/**
 * Variables
 */

var commands = new db.Dao('commands');
var scripts = new db.Dao('scripts');



/**
 * Load all the command/script files in the given directory
 */

var loadDirectory = function (path) {
	fs.readdir(path, function (err, files) {
		if (err) throw err;
		var commands = /^.*\.commands$/;
		var script = /^.*\.script$/;
		files.forEach(function (file) {
			if (script.test(file)) {
				loadScriptFile(path + file);
			} else if (commands.test(file)) {
				loadCommandFile(path + file);
			}
		});
	});
}



/**
 * Load a command file and insert it in the commands collection.
 */

var loadCommandFile = function (filename) {
	logger.info('[ModuleInstaller] Start loading commands file: ' + filename);
	// Read filename for type (script/module) and version
	var regex = /^.*[\\\/]([^\\\/]*)_(\d(?:\.\d)*)\.commands$/g;
	var split = regex.exec(filename);
	var script, version, module;
	if (split != null) {
		script = split[1];
		version = split[2];
	} else {
		regex = /^.*[\\\/]([^\\\/]*)\.commands$/g;
		split = regex.exec(filename);
		module = split[1];
	}
	// Read file content
	fileContents = fs.readFileSync(filename, 'UTF-8');
	// Populate commands to insert
	var commandsToInsert = [];
	fileContents.split('\n').forEach(function (line) {
		var split = line.split('=');
		// If the line is of type 'key=value' and starts not with a '#'. The join is used because the value can have '=' characters
		var key = split.shift().trim();
		var value = split.join('=').trim();
		if (key.length > 0 && key.charAt(0) != '#' && value.length > 0) {
			// If script command
			var command;
			if (script === undefined) {
				command = {
					name:		key,
					command:	new Buffer(value).toString('base64'),
					module:		module
				};
			}
			// If module command
			else {
				command = {
					name:		key,
					arguments:	new Buffer(value).toString('base64'),
					script:		script,
					version:	version
				};
			}
			// Push command to insert
			commandsToInsert.push(command);
		}
	});
	// Remove old commands and then insert
	var selector = script !== undefined ? {script: script} : {module: module};
	commands._remove(selector, {}, function () {
		commands.insert(commandsToInsert, function (result) {
			logger.info('[ModuleInstaller] Commands file ' + filename + ' loaded');
		});
	});
};



/**
 * Load a script in DB.
 * If the script already exists in DB, update it only if
 * he is outdated (version outdated).
 */

var loadScriptFile = function (filename) {
	logger.info('[ModuleInstaller] Start loading script file: ' + filename);
	var regex = /^.*[\\\/]([^\\\/]*)_(\d(?:\.\d)*)\.script$/g;
	var split = regex.exec(filename);
	var name = split[1];
	var version = split[2];
	// Search the script in DB
	scripts.findOne({name: name}, function (script) {
		// If the script in DB is outdated
		if (script !== null && utils.compareVersions(script.version, version) < 0) {
			fs.readFile(filename, function (err, content) {
				if (err) throw "Unable to read script file " + filename + ", error: " + err;
				scripts.update(script._id, {version: version, content: content}, function () {
					logger.info('[ModuleInstaller] Script file ' + filename + ' loaded (updated)');
				});
			});
		}
		// If there is no script in DB
		else if (script === null) {
			fs.readFile(filename, function (err, content) {
				if (err) throw "Unable to read script file " + filename + ", error: " + err;
				scripts.insert({name: name, version: version, content: content}, function () {
					logger.info('[ModuleInstaller] Script file ' + filename + ' loaded (inserted)');
				});
			});
		}
		// If script up to date in DB
		else {
			logger.info('[ModuleInstaller] Script up to date in DB');
		}
	})
};



/**
 * Exports
 */

exports.loadDirectory = loadDirectory;