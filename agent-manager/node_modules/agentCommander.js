/**
 * =============================
 *
 * Executes commands and scripts on the agent.
 *
 * This module abstracts totally the management of
 * the scripts, versions...
 * Only the script name and the parameters are needed.
 *
 * The parameters must be of the type : {key: value, ...}
 * In the command or script arguments, the parameters
 * can be set with mustaches: {{key}}
 * This templating works only with de commands and script
 * arguments. Not in the script contents.
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods :
 *		- command(name, parameters, [callback])
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Global
var logger = require('logger');
var config = require('config');
var db = require('db');
// Custom
var protocol = require('protocol');



/**
 * Variables
 */

// DAO
var agentManagerMessagesDao = new db.Dao('agentManagerMessages');
var commandsDao = new db.Dao('commands');
var scriptsDao = new db.Dao('scripts');



/**
 * Listen to new commands from the API
 */

var listen = function () {
	agentManagerMessagesDao.listen(function(err, message) {
		logger.info('[Agent Commander] New message received from API : ' + JSON.stringify(message));
		// Find command in DB
		commandsDao.findOne({name: message.command}, function (err, dbCommand) {
			// Check if command exists
			if (!dbCommand) {
				logger.warn('[Agent Commander] Unknown command received from API : ' + message.command);
				agentManagerMessagesDao.update(message._id, {status: 'err'});
				return;
			}
			// If it is a script find it and send it to the agent
			if (dbCommand.script !== undefined) {
				scriptsDao.findOne({name: dbCommand.script}, function(err, dbScript) {
					if (dbScript) {
						protocol.sendCommand(message.device, dbScript.scriptName, dbScript.version, prepareBase64String(dbCommand.arguments, message.parameters));
						logger.info('[Agent Commander] ' + dbCommand.scripts + ' script sent to agent');	// TODO update message status in DB
						agentManagerMessagesDao.update(message._id, {status: 'sta'});
					} else {
						logger.warning('[Agent Commander] ' + dbCommand.scripts + ' script no found in database');
					}
				});
			}
			// If it is a command, send the command to the agent
			else {
				protocol.sendCommand(message.device, prepareBase64String(dbCommand.command, message.parameters));
				logger.info('[Agent Commander] Command send to agent');	// TODO update message status in DB
				agentManagerMessagesDao.update(message._id, {status: 'sta'});
			}
		});
	});
};



/**
 * Prepare the string encoded in base 64 by replacing the {{}} by the parameters.
 * Returns a base64 encoded string.
 */
var prepareBase64String = function (string, parameters) {
	var preparedString = new Buffer(string, 'base64').toString('ascii');
	for (var parameter in parameters) {
		var regexp = new RegExp('{{' + parameter + '}}', 'g')
		preparedString = preparedString.replace(regexp, parameters[parameter]);
	}
	preparedString = new Buffer(preparedString).toString('base64');
	return preparedString;
};



/**
 * Exports
 */

// methods
exports.listen = listen;