/**
 * =============================
 *
 * Manages all the applications to dev easily.
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods : /
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var http = require('http');
var fs = require('fs');
var io = require('socket.io');
// Global
var commander = require('commander');
var dbCommander = require('dbCommander');
var db = require('db');
var config = require('config');
// Custom
var scriptsLoader = require('scriptsLoader');
var apiAnalyzer = require('apiAnalyzer');



/**
 * Variables
 */

var host = config.get('host');
var port = config.get('port');
// Pre-loaded frequently-user web-pages
var index = fs.readFileSync(__dirname + '/../frontend/index.html');
// Dao
var scriptsDao = new db.Dao('scripts');
var commandsDao = new db.Dao('commands');
var apiDocDao = new db.Dao('api', 'doc');



/**
 * Initialize the WebServer
 */

var server = http.createServer(function (req, res) {
	if (req.url == '/') {
		req.url = '/index.html';
	}
	fs.readFile(__dirname + '/../frontend' + req.url, function (err, data) {
		if (err) {
			res.writeHead(404);
			res.write(index);
		} else {
			res.writeHead(200);
			res.write(data);
		}
		res.end();
	});
});



/**
 * Initialize Socket.io client socket
 */

var initClient = function (socket) {
	// Set listeners
	socket.on('stopService', function (data) {
		_service('stop', data);
	});
	socket.on('startService', function (data) {
		_service('start', data);
	});
	socket.on('restartService', function (data) {
		_service('restart', data);
	});
	socket.on('statusService', function () {
		_getAndSendStatus();
	});
	socket.on('getConsole', function () {
		_getConsole();
	});
	socket.on('reloadScripts', function () {
		scriptsLoader.loadDirectory('/home/laurent/OMS/Sources/Scripts/');
	});
	socket.on('getCommands', function () {
		commandsDao.findAll(function (result) {
			socket.emit('commands', JSON.stringify(result));
		});
	});
	socket.on('getScripts', function () {
		scriptsDao.findAll(function (result) {
			socket.emit('scripts', JSON.stringify(result));
		});
	});
	socket.on('reloadApiDoc', function () {
		apiAnalyzer.analyze('/home/laurent/OMS/Sources/API/');
	});
	socket.on('getApiDoc', function () {
		apiDocDao.findAll(function (apis) {
			socket.emit('apiDoc', JSON.stringify(apis));
		});
	});
};



/**
 * General methods executing commands
 */

// Execute oms service commands
var _service = function (commandName, services) {
	dbCommander.command(commandName + '-services', {services: services.join(' ')}, function (result) {
		io.sockets.emit('result', result.data);
	});
};

// Get the services status and send it to the browsers
var _getAndSendStatus = function () {
	dbCommander.command('status-services', {services: 'oms-agent oms-agent-manager oms-admin-panel oms-dev-helper oms-api'}, function (result) {
		io.sockets.emit('oms-status', result.data);
	});
	dbCommander.command('status-services', {services: 'mongodb'}, function (result) {
		io.sockets.emit('mongodb-status', result.data);
	});
};

// Get the last 10 logs of each service
var _getConsole = function () {
	dbCommander.command('get-logs', {lines: 10, filename: '/var/log/oms/agent.log'}, function (result) {
		io.sockets.emit('console-init', 'oms-agent', result.data);
	});
	dbCommander.command('get-logs', {lines: 10, filename: '/var/log/oms/agent-manager.log'}, function (result) {
		io.sockets.emit('console-init', 'oms-agent-manager', result.data);
	});
	dbCommander.command('get-logs', {lines: 10, filename: '/var/log/oms/admin-panel.log'}, function (result) {
		io.sockets.emit('console-init', 'oms-admin-panel', result.data);
	});
	dbCommander.command('get-logs', {lines: 10, filename: '/var/log/oms/dev-helper.log'}, function (result) {
		io.sockets.emit('console-init', 'oms-dev-helper', result.data);
	});
	dbCommander.command('get-logs', {lines: 10, filename: '/var/log/oms/api.log'}, function (result) {
		io.sockets.emit('console-init', 'oms-api', result.data);
	});
};



/**
 * Check the services status
 * and stream the log updates
 */

var _listenToLogs = function () {
	dbCommander.daemon('stream-logs', {filename: '/var/log/oms/agent.log'}, function (daemon) {
		daemon.on('data', function (data) {
			io.sockets.emit('console-update', 'oms-agent', data);
		});
	});
	dbCommander.daemon('stream-logs', {filename: '/var/log/oms/agent-manager.log'}, function (daemon) {
		daemon.on('data', function (data) {
			io.sockets.emit('console-update', 'oms-agent-manager', data);
		});
	});
	dbCommander.daemon('stream-logs', {filename: '/var/log/oms/admin-panel.log'}, function (daemon) {
		daemon.on('data', function (data) {
			io.sockets.emit('console-update', 'oms-admin-panel', data);
		});
	});
	dbCommander.daemon('stream-logs', {filename: '/var/log/oms/dev-helper.log'}, function (daemon) {
		daemon.on('data', function (data) {
			io.sockets.emit('console-update', 'oms-dev-helper', data);
		});
	});
	dbCommander.daemon('stream-logs', {filename: '/var/log/oms/api.log'}, function (daemon) {
		daemon.on('data', function (data) {
			io.sockets.emit('console-update', 'oms-api', data);
		});
	});
};



/**
 * Start
 */

var start = function () {
	// Start webserver
	server.listen(port, host);

	// Socket IO
	io = io.listen(server, { log: false });
	io.set('log level', 1);

	// Socket IO handlers
	io.sockets.on('connection', function (socket) {
		initClient(socket);
	});

	// Send oms-status every 3 seconds
	setInterval(_getAndSendStatus, 3000);

	// Listen to logs and send through socket.io
	_listenToLogs();
};



/**
 * Stop
 */

var stop = function(callback) {
	server.close(callback);
};



/**
 * Exports
 */

// Methods
exports.start = start;
exports.stop = stop;