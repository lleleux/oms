/**
 * =============================
 *
 * API Express server
 * Set the route listening on, start/stop the server...
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods :
 *		- start([callback])
 *		- stop([callback])
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var express = require('express');
// Global
var logger = require('logger');
var config = require('config');
// Custom
var deviceRoutes = require('../routes/device.js');
var installRoutes = require('../routes/install.js');


/**
 * Variables
 */

// Server
var server = express();
// Host/port
var host = config.host;
var port = config.port;


/**
 * Configure server:
 * 		- use logger
 *		- allow cross-domain
 */

var _configureServer = function () {
	var allowCrossDomain = function(req, res, next) {
		// Send headers
		res.header('Access-Control-Allow-Origin', '*');
		res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');
		res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, Content-Length, X-Requested-With');
		// Intercept OPTIONS method
		if ('OPTIONS' == req.method) {
			res.send(200);
		} else {
			next();
		}
	};

	server.configure(function () {
		server.use(express.logger('dev'));
		server.use(allowCrossDomain);
		server.use(express.bodyParser());
	});
};



/**
 * Configure server routes
 */

var _configureRoutes = function () {
	// Devices
	server.get('/device', deviceRoutes.findAll);
	server.get('/device/:id', deviceRoutes.findById);
	server.post('/device', deviceRoutes.insert);
	server.put('/device/:id', deviceRoutes.update);
	server.delete('/device/:id', deviceRoutes.remove);
	server.post('/device/:id/command/:name', deviceRoutes.execute);

	// Installations
	server.get('/install', installRoutes.findAll);
	server.get('/install/:id', installRoutes.findById);
	server.post('/install', installRoutes.insert);
	server.put('/install/:id', installRoutes.update);
	server.delete('/install/:id', installRoutes.remove);
	server.post('/install/:id/accept', installRoutes.accept);
	server.post('/install/:id/reject', installRoutes.reject);
};



/**
 * Start the API Server
 *
 * @param callback function called when the web server is listening
 */

var start = function (callback) {
	_configureServer();
	_configureRoutes();
	server = server.listen(port, host, function () {
		logger.info('[Server] Web server listening on ' + host + ':' + port);
		if (callback) callback();
	});
};



/**
 * Stop the API Server
 *
 * @param callback function called when the web server is no more listening
 */

var stop = function (callback) {
	if (typeof server.close == 'function') {
		server.close(function () {
			logger.info('[Server] Web server no more listening on ' + host + ':' + port);
			if (callback) callback();
		});
	} else {
		logger.info('[Server] Cannot stop web server listening on ' + host + ':' + port);
		if (callback) callback();
	}
};



/**
 * Exports
 */

exports.start = start;
exports.stop = stop;