/**
 * =============================
 *
 * Manages all the applications to dev easily.
 *
 * =============================
 *
 * Attributes : /
 *
 * Methods : /
 *
 * Events : /
 *
 * =============================
 */



/**
 * Load modules
 */

// Built-in
var fs = require('fs');
var express = require('express');
var io = require('socket.io');
// Global
var commander = require('commander');
var dbCommander = require('dbCommander');
var db = require('db');
var config = require('config');
var logger = require('logger');
// Custom
var scriptsLoader = require('scriptsLoader');
var sshCommander = require('sshCommander');
var installerGenerator = require('installerGenerator');
var servers = require('../routes/servers.js');
var doc = require('../routes/doc.js');



/**
 * Variables
 */

var host = config.host;
var port = config.port;
// Pre-loaded frequently-user web-pages
var index = fs.readFileSync(__dirname + '/../frontend/index.html');
// Dao
var scriptsDao = new db.Dao('scripts');
var commandsDao = new db.Dao('commands');
var serversDao = new db.Dao('servers');



/**
 * Initialize the WebServer
 */

// Create server
var server = express();

// Logging
server.use(express.logger('dev'));
server.use(express.bodyParser());
// Templating
server.get('/js/app.js', function(req, res) {
	var hostname = config.publicHost ? config.publicHost : config.server;
	var contents = fs.readFileSync(__dirname + '/../frontend/js/app.js').toString();
	contents = contents.replace(/{{hostname}}/g, hostname);
	contents = contents.replace(/{{port}}/g, config.port);
	res.set('Content-Type', 'application/javascript');
	res.send(contents);
});
// Static JS/Images...
server.use(express.static(__dirname + '/../frontend'));
// Static intallers files
server.use('/files/installers', express.static(config.serviceTmpDir + config.installersDir));

// Set routes
server.get('/api/server', servers.findAll);
server.delete('/api/server/:id', servers.remove);
server.delete('/api/server/:id/service/:name', servers.removeService);
// Server Config
server.get('/api/server/:id/config/:key', servers.getServerConfig);
server.post('/api/server/:id/config/:key', servers.setServerConfig);
server.delete('/api/server/:id/config/:key', servers.removeServerConfig);
server.put('/api/server/:id/config/:key', servers.addServerConfig);
// Service Config
server.get('/api/server/:id/service/:name/config/:key', servers.getServiceConfig);
server.post('/api/server/:id/service/:name/config/:key', servers.setServiceConfig);
server.delete('/api/server/:id/service/:name/config/:key', servers.removeServiceConfig);
server.put('/api/server/:id/service/:name/config/:key', servers.addServiceConfig);
// API Documentation
server.get('/api/doc/api', doc.findAllApi);
server.get('/api/doc/dev-helper', doc.findAllDevHelper);
server.post('/api/doc/reload', doc.reload);

// Default route
server.use(function(req, res, next) {
	res.set('Content-Type', 'text/html');
	res.send(index);
});



/**
 * Initialize Socket.io client socket
 */

var initClient = function (socket) {
	// Services
	socket.on('stopServices', function (data) {
		_service('stop', data.hostname, data.services);
	});
	socket.on('startServices', function (data) {
		_service('start', data.hostname, data.services);
	});
	socket.on('restartServices', function (data) {
		_service('restart', data.hostname, data.services);
	});
	socket.on('getConsole', function (data) {
		_getLogs(data.hostname, data.serviceName);
	});

	// Scripts & commands
	socket.on('reloadScripts', function () {
		scriptsLoader.loadDirectory('/home/laurent/OMS/Sources/scripts/');
	});
	socket.on('getCommands', function () {
		commandsDao.findAll(function (err, result) {
			socket.emit('commands', JSON.stringify(result));
		});
	});
	socket.on('getScripts', function () {
		scriptsDao.findAll(function (err, result) {
			socket.emit('scripts', JSON.stringify(result));
		});
	});

	// Installers
	socket.on('generateInstallers', function () {
		installerGenerator.generateServices();
	});
	socket.on('getInstallers', function () {
		socket.emit('installers', installerGenerator.getInstallers());
	});
};



/**
 * General methods executing commands
 */

// Execute oms service commands
var _service = function (commandName, hostname, services) {
	sshCommander.command(hostname, commandName + '-services', {services: services.join(' ')}, function (err, result) {
		_refresh();
	});
};

// Get the last 30 logs of a service
var _getLogs = function (hostname, service) {
	var logfiles = {
		'oms-api':				'/var/log/oms/api.log',
		'oms-dev-helper':		'/var/log/oms/dev-helper.log',
		'oms-agent-manager':	'/var/log/oms/agent-manager.log',
		'oms-admin-panel':		'/var/log/oms/admin-panel.log'
	};
	sshCommander.command(hostname, 'get-logs', {lines: 30, filename: logfiles[service]}, function (err, result) {
		if (result) {
			io.sockets.emit('console', hostname, service, result.data);
		} else {
			logger.warn('[Server] Unable to send logs to socket.io client: ' + err.message);
		}
	});
};

// Send refresh to clients
var _refresh = function () {
	serversDao.findAll(function (err, servers) {
		io.sockets.emit('refresh', servers);
	});
};



/**
 * Start
 */

var start = function () {
	// Start webserver
	server = server.listen(port, host);

	// Socket IO
	io = io.listen(server, { log: false });
	io.set('log level', 1);

	// Socket IO handlers
	io.sockets.on('connection', function (socket) {
		initClient(socket);
	});
};



/**
 * Stop
 */

var stop = function(callback) {
	server.close(callback);
};



/**
 * Exports
 */

// Methods
exports.start = start;
exports.stop = stop;